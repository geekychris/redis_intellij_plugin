name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.2.3

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'
          
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        
      - name: Update version in build.gradle.kts
        run: |
          sed -i "s/version = \".*\"/version = \"${{ steps.version.outputs.VERSION }}\"/" build.gradle.kts
          
      - name: Run tests
        run: ./gradlew test
        
      - name: Build plugin
        run: ./gradlew buildPlugin
        
      - name: Verify plugin
        run: ./gradlew verifyPlugin
        
      - name: List build artifacts
        run: |
          echo "Contents of build/distributions:"
          ls -lah build/distributions/
          echo ""
          echo "Plugin artifact:"
          find build/distributions -name "*.zip" -exec ls -lh {} \;
          
      - name: Get plugin filename
        id: plugin_file
        run: |
          PLUGIN_FILE=$(find build/distributions -name "*.zip" -type f | head -n 1)
          echo "file=${PLUGIN_FILE}" >> $GITHUB_OUTPUT
          echo "Found plugin file: ${PLUGIN_FILE}"
        
      - name: Sign plugin
        if: false  # Enable this step by setting to true after configuring signing secrets
        env:
          CERTIFICATE_CHAIN: ${{ secrets.CERTIFICATE_CHAIN }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          PRIVATE_KEY_PASSWORD: ${{ secrets.PRIVATE_KEY_PASSWORD }}
        run: ./gradlew signPlugin
        
      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # If no previous tag, get all commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits between previous tag and current
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save changelog to file
          echo "$CHANGELOG" > CHANGELOG.txt
          echo "Generated changelog for release"
          
      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-distribution
          path: ${{ steps.plugin_file.outputs.file }}
          retention-days: 90
          
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PLUGIN_FILE="${{ steps.plugin_file.outputs.file }}"
          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG="v${VERSION}"
          
          echo "Creating release ${TAG}"
          echo "Uploading file: ${PLUGIN_FILE}"
          
          # Delete release if it exists (for re-runs)
          if gh release view "${TAG}" &>/dev/null; then
            echo "Release ${TAG} already exists, deleting it"
            gh release delete "${TAG}" --yes --cleanup-tag
          fi
          
          # Create release and upload asset
          gh release create "${TAG}" \
            --title "Release ${VERSION}" \
            --notes-file CHANGELOG.txt \
            "${PLUGIN_FILE}"
            
          echo "Release created successfully with asset: ${PLUGIN_FILE}"
          
      - name: Publish to JetBrains Marketplace
        if: false  # Enable this step by setting to true after configuring PUBLISH_TOKEN secret
        env:
          PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
        run: ./gradlew publishPlugin
